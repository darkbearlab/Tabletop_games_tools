<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兵牌製造機</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --accent-color: #4caf50;
            --paper-width: 210mm;
            --paper-height: 297mm;
            --counter-size: 15mm;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: row;
            height: 100vh;
            overflow: hidden;
        }

        /* 左側控制面板 - 緊湊化 */
        .controls {
            width: 300px; /* 稍微縮窄 */
            padding: 15px; /* 減少內距 */
            background-color: #252525;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px; /* 減少元件間距 */
            z-index: 100;
        }

        /* 捲軸美化 (Chrome/Safari) */
        .controls::-webkit-scrollbar { width: 8px; }
        .controls::-webkit-scrollbar-track { background: #333; }
        .controls::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        .controls::-webkit-scrollbar-thumb:hover { background: #777; }

        h1 {
            color: var(--accent-color);
            font-size: 1.2rem; /* 字體變小 */
            margin: 0 0 5px 0;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--accent-color);
            background: rgba(76, 175, 80, 0.1);
            padding: 4px 8px;
            border-radius: 3px;
            margin-bottom: 2px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-bottom: 2px;
        }

        label {
            font-size: 0.75rem; /* 標籤字體變小 */
            font-weight: bold;
            color: #aaa;
        }

        input[type="text"], input[type="number"], textarea, select {
            padding: 4px 6px; /* 輸入框變扁 */
            border-radius: 3px;
            border: 1px solid #555;
            background-color: #333;
            color: white;
            box-sizing: border-box;
            width: 100%;
            font-family: inherit;
            font-size: 0.85rem;
        }

        textarea { 
            resize: vertical; 
            min-height: 35px; /* 文字框變矮 */
            height: 35px;
        }

        /* 緊湊行：將顏色和不透明度放在同一行 */
        .compact-row {
            display: flex;
            gap: 5px;
            align-items: flex-end;
        }
        .compact-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        input[type="color"] {
            width: 100%;
            height: 25px; /* 顏色選擇器變扁 */
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
        }

        /* 滑桿調整 */
        input[type="range"] {
            height: 25px;
            margin: 0;
            width: 100%;
        }

        .file-input-wrapper { display: flex; gap: 5px; align-items: center; }
        .file-input-wrapper input[type="file"] { flex-grow: 1; font-size: 0.75rem; }
        
        .preview-img-box {
            width: 100%; 
            height: 60px; /* 預覽圖高度減半 */
            border: 1px dashed #555;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; background: #000; margin-top: 2px;
        }

        /* 按鈕群組 */
        .btn-group {
            display: flex;
            gap: 5px;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 3px;
            padding: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            transition: 0.2s;
        }
        
        button.primary-btn {
            background-color: var(--accent-color);
            color: white;
            width: 100%;
            margin-top: 5px;
        }
        button.primary-btn:hover { background-color: #43a047; }
        
        button.secondary { 
            background-color: #444; 
            color: #ddd; 
            flex: 1; /* 平分寬度 */
            font-size: 0.85rem;
            padding: 6px;
        }
        button.secondary:hover { background-color: #555; }

        /* 右側預覽/列印區 */
        .preview-area {
            flex-grow: 1;
            background-color: #555;
            padding: 40px;
            overflow: auto;
            display: flex;
            justify-content: center;
        }

        .sheet {
            width: var(--paper-width);
            min-height: var(--paper-height);
            background-color: white;
            padding: 10mm;
            box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: grid;
            grid-template-columns: repeat(auto-fill, var(--counter-size));
            grid-auto-rows: max-content;
            gap: 0;
            align-content: start;
            justify-content: start;
        }

        .counter-container {
            width: var(--counter-size);
            height: calc(var(--counter-size) * 2);
            position: relative;
            box-sizing: border-box;
            page-break-inside: avoid;
            margin: 0;
            overflow: visible; 
            z-index: 1;
            outline: 1px dashed rgba(0,0,0,0.3);
            outline-offset: -0.5px;
        }

        .show-lines .counter-container::after,
        .show-lines .counter-container::before {
            content: "";
            position: absolute;
            z-index: 100;
            pointer-events: none;
            width: 6mm; height: 6mm;
            background: 
                linear-gradient(to right, transparent 2.8mm, black 2.8mm, black 3.2mm, transparent 3.2mm),
                linear-gradient(to bottom, transparent 2.8mm, black 2.8mm, black 3.2mm, transparent 3.2mm);
            mix-blend-mode: multiply;
            opacity: 0.8; 
        }
        .show-lines .counter-container::after { bottom: -3mm; right: -3mm; }
        .show-lines .counter-container::before { top: -3mm; left: -3mm; }

        .counter-part {
            width: 100%;
            height: 50%;
            display: flex;
            overflow: hidden;
            position: relative;
            background: #ccc;
        }

        .counter-part img {
            width: 100%; height: 100%;
            display: block;
            object-fit: cover; 
            object-position: top left;
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
        }

        /* 文字樣式：靠左置底 */
        .overlay-text {
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: 10;
            text-align: left;
            width: auto;
            max-width: 100%;
            white-space: pre-wrap;
            padding: 0 2px; /* 稍微減少 padding */
            font-size: 11px; 
            line-height: 1.1;
            font-weight: bold;
            pointer-events: none;
            word-wrap: break-word;
        }

        .counter-back {
            transform: rotate(180deg);
            border-bottom: 1px dotted rgba(0,0,0,0.3); 
            box-sizing: border-box;
        }

        .delete-btn {
            position: absolute;
            top: 2px; right: 2px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            width: 16px; height: 16px;
            text-align: center;
            line-height: 14px;
            cursor: pointer;
            font-size: 12px;
            z-index: 200;
            display: none;
        }
        .counter-container:hover .delete-btn { display: block; }

        @media print {
            body { background-color: white; height: auto; display: block; }
            .controls { display: none; }
            .preview-area { padding: 0; overflow: visible; }
            .sheet { box-shadow: none; margin: 0; width: 100%; height: auto; padding: 10mm; }
            .delete-btn { display: none !important; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .show-lines .counter-container::before,
            .show-lines .counter-container::after { opacity: 1; filter: contrast(150%); }
        }
    </style>
</head>
<body>

    <div class="controls">
        <h1>兵牌製造機</h1>
        
        <div class="section-title">1. 正面 (Front)</div>
        <div class="input-group">
            <input type="file" id="frontInput" accept="image/*" style="font-size: 0.7rem;">
            <div class="preview-img-box" id="frontPreviewBox">
                <span style="font-size: 10px; color:#555;">預覽</span>
            </div>
        </div>
        <div class="input-group">
            <textarea id="frontText" placeholder="正面文字..."></textarea>
        </div>
        <div class="compact-row">
            <div class="compact-col" style="flex:0.5;">
                <label>字色</label>
                <input type="color" id="frontTextColor" value="#ffffff">
            </div>
            <div class="compact-col" style="flex:0.5;">
                <label>底色</label>
                <input type="color" id="frontBgColor" value="#000000">
            </div>
            <div class="compact-col" style="flex:1.2;">
                <label style="display:flex; justify-content:space-between;">
                    <span>不透明</span><span id="frontOpacityVal" style="font-weight:normal;">0.5</span>
                </label>
                <input type="range" id="frontOpacity" min="0" max="1" step="0.1" value="0.5" oninput="document.getElementById('frontOpacityVal').innerText = this.value">
            </div>
        </div>

        <hr style="border:0; border-top:1px solid #444; width:100%; margin: 5px 0;">

        <div class="section-title">2. 背面 (Back)</div>
        <div class="input-group">
            <div class="file-input-wrapper">
                <input type="file" id="backInput" accept="image/*" style="font-size: 0.7rem;">
                <button id="clearBackBtn" onclick="clearBack()" style="width:20px; height:20px; background:#d32f2f; padding:0; display:none; font-size:12px; line-height:1;">×</button>
            </div>
            <div style="font-size: 0.7rem; color: #888;" id="backStatus">無 (使用正面鏡像)</div>
        </div>
        <div class="input-group">
            <textarea id="backText" placeholder="背面文字..."></textarea>
        </div>
        <div class="compact-row">
            <div class="compact-col" style="flex:0.5;">
                <label>字色</label>
                <input type="color" id="backTextColor" value="#ffffff">
            </div>
            <div class="compact-col" style="flex:0.5;">
                <label>底色</label>
                <input type="color" id="backBgColor" value="#000000">
            </div>
            <div class="compact-col" style="flex:1.2;">
                <label style="display:flex; justify-content:space-between;">
                    <span>不透明</span><span id="backOpacityVal" style="font-weight:normal;">0.5</span>
                </label>
                <input type="range" id="backOpacity" min="0" max="1" step="0.1" value="0.5" oninput="document.getElementById('backOpacityVal').innerText = this.value">
            </div>
        </div>

        <hr style="border:0; border-top:1px solid #444; width:100%; margin: 5px 0;">

        <div class="section-title">3. 輸出</div>
        <div class="compact-row">
            <div class="compact-col">
                <label>邊長(mm)</label>
                <input type="number" id="counterSize" value="15" onchange="updateGridSize()">
            </div>
            <div class="compact-col">
                <label>數量</label>
                <input type="number" id="copyCount" value="1" min="1">
            </div>
        </div>
        
        <div class="input-group" style="margin-top:5px;">
            <div style="display:flex; align-items:center; gap:5px;">
                <input type="checkbox" id="showLinesCheck" onchange="toggleLines()" checked style="width:auto; margin:0;">
                <label for="showLinesCheck" style="color:#ddd; cursor:pointer;">顯示井字裁切線</label>
            </div>
        </div>

        <button class="primary-btn" onclick="addToSheet()">加入 (Add)</button>
        <div class="btn-group">
            <button class="secondary" onclick="clearSheet()">清空 (Clear)</button>
            <button class="secondary" onclick="window.print()">列印 (Print)</button>
        </div>
    </div>

    <div class="preview-area">
        <div class="sheet show-lines" id="printSheet"></div>
    </div>

    <script>
        const frontPreviewBox = document.getElementById('frontPreviewBox');
        const printSheet = document.getElementById('printSheet');
        const backStatus = document.getElementById('backStatus');
        const clearBackBtn = document.getElementById('clearBackBtn');
        
        let frontImgData = null;
        let backImgData = null;

        function hexToRgba(hex, alpha) {
            let c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c= hex.substring(1).split('');
                if(c.length== 3){
                    c= [c[0], c[0], c[1], c[1], c[2], c[2]];
                }
                c= '0x'+c.join('');
                return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
            }
            return hex;
        }

        function handleFileSelect(inputElement, callback) {
            inputElement.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    callback(event.target.result);
                };
                reader.readAsDataURL(file);
            });
        }

        handleFileSelect(document.getElementById('frontInput'), (data) => {
            frontImgData = data;
            frontPreviewBox.innerHTML = `<img src="${data}" style="width:100%; height:100%; object-fit:cover; object-position:top left;">`;
        });

        handleFileSelect(document.getElementById('backInput'), (data) => {
            backImgData = data;
            backStatus.innerText = "已載入";
            backStatus.style.color = "#4caf50";
            clearBackBtn.style.display = "block";
        });

        function clearBack() {
            document.getElementById('backInput').value = '';
            backImgData = null;
            backStatus.innerText = "無 (使用正面鏡像)";
            backStatus.style.color = "#888";
            clearBackBtn.style.display = "none";
        }

        function toggleLines() {
            const check = document.getElementById('showLinesCheck');
            if(check.checked) {
                printSheet.classList.add('show-lines');
            } else {
                printSheet.classList.remove('show-lines');
            }
        }

        function updateGridSize() {
            const size = document.getElementById('counterSize').value;
            document.documentElement.style.setProperty('--counter-size', size + 'mm');
        }

        function createCounterElement(config) {
            const container = document.createElement('div');
            container.className = 'counter-container';

            // 背面
            const backDiv = document.createElement('div');
            backDiv.className = 'counter-part counter-back';
            const bImg = config.bImg ? config.bImg : config.fImg;
            backDiv.innerHTML = `<img src="${bImg}">`;

            if (config.bText) {
                const span = document.createElement('div');
                span.className = 'overlay-text';
                span.innerText = config.bText;
                span.style.color = config.bTextColor;
                span.style.backgroundColor = hexToRgba(config.bBgColor, config.bOpacity);
                backDiv.appendChild(span);
            }

            // 正面
            const frontDiv = document.createElement('div');
            frontDiv.className = 'counter-part counter-front';
            frontDiv.innerHTML = `<img src="${config.fImg}">`;

            if (config.fText) {
                const span = document.createElement('div');
                span.className = 'overlay-text';
                span.innerText = config.fText;
                span.style.color = config.fTextColor;
                span.style.backgroundColor = hexToRgba(config.fBgColor, config.fOpacity);
                frontDiv.appendChild(span);
            }

            const delBtn = document.createElement('div');
            delBtn.className = 'delete-btn';
            delBtn.innerHTML = '×';
            delBtn.onclick = function() { container.remove(); };

            container.appendChild(delBtn);
            container.appendChild(backDiv); 
            container.appendChild(frontDiv); 

            return container;
        }

        function addToSheet() {
            if (!frontImgData) {
                alert("請至少上傳正面圖片！");
                return;
            }
            updateGridSize();
            
            const config = {
                fImg: frontImgData,
                fText: document.getElementById('frontText').value,
                fTextColor: document.getElementById('frontTextColor').value,
                fBgColor: document.getElementById('frontBgColor').value,
                fOpacity: document.getElementById('frontOpacity').value,
                
                bImg: backImgData,
                bText: document.getElementById('backText').value,
                bTextColor: document.getElementById('backTextColor').value,
                bBgColor: document.getElementById('backBgColor').value,
                bOpacity: document.getElementById('backOpacity').value
            };

            const count = document.getElementById('copyCount').value;
            
            for (let i = 0; i < count; i++) {
                const el = createCounterElement(config);
                printSheet.appendChild(el);
            }
        }

        function clearSheet() {
            if(confirm("確定要清空所有兵牌嗎？")) printSheet.innerHTML = '';
        }
        
        updateGridSize();
    </script>
</body>
</html>

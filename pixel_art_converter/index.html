<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Art Converter (GameBoy Style)</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        h1 { margin-bottom: 20px; text-transform: uppercase; border-bottom: 2px solid #e74c3c; }
        
        .controls {
            background: #34495e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            max-width: 800px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        label { margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input[type="range"] { cursor: pointer; }
        
        .btn {
            background-color: #e67e22;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
            transition: background 0.3s;
        }
        .btn:hover { background-color: #d35400; }
        .btn-download { background-color: #27ae60; }
        .btn-download:hover { background-color: #2ecc71; }

        #canvas-container {
            position: relative;
            border: 4px solid #95a5a6;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAADFJREFUOE9jZGVl/c+AEzCSqHgUE2AAiG109//Jkyf/kTQ9jY6G4WgYkA4GHOanhQEA+ygT915/6qEAAAAASUVORK5CYII='); /* 透明背景格 */
        }
        
        canvas {
            display: block;
            max-width: 100%;
            height: auto;
            image-rendering: pixelated; /* 關鍵 CSS：讓瀏覽器不要模糊化像素 */
        }
    </style>
</head>
<body>

    <h1>像素藝術轉換器</h1>

    <div class="controls">
        <div class="control-group">
            <label>1. 上傳圖片</label>
            <input type="file" id="upload" accept="image/*">
        </div>

        <div class="control-group">
            <label for="pixelSize">像素大小 (解析度): <span id="pixelVal">4</span></label>
            <input type="range" id="pixelSize" min="1" max="50" value="4">
        </div>

        <div class="control-group">
            <label for="colorDepth">色彩簡化 (色階): <span id="colorVal">16</span></label>
            <input type="range" id="colorDepth" min="2" max="32" value="16" step="2">
            <small>數值越小，顏色越少</small>
        </div>

        <div class="control-group">
            <label>特效濾鏡</label>
            <div>
                <input type="checkbox" id="gbMode"> 
                <label for="gbMode" style="display:inline; cursor:pointer;">開啟 GameBoy 模式</label>
            </div>
            <div style="margin-top:5px;">
                <input type="checkbox" id="dither"> 
                <label for="dither" style="display:inline; cursor:pointer;">開啟抖動 (Dithering)</label>
            </div>
        </div>
        
        <div class="control-group" style="justify-content: flex-end;">
            <button class="btn btn-download" id="downloadBtn">下載圖片</button>
        </div>
    </div>

    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <script>
        const upload = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const pixelSizeInput = document.getElementById('pixelSize');
        const colorDepthInput = document.getElementById('colorDepth');
        const gbModeInput = document.getElementById('gbMode');
        const ditherInput = document.getElementById('dither');
        const pixelVal = document.getElementById('pixelVal');
        const colorVal = document.getElementById('colorVal');
        const downloadBtn = document.getElementById('downloadBtn');

        let img = new Image();
        
        // 經典 GameBoy 綠色調色盤 (最深 -> 最淺)
        const gbPalette = [
            {r: 15, g: 56, b: 15},   // #0f380f
            {r: 48, g: 98, b: 48},   // #306230
            {r: 139, g: 172, b: 15}, // #8bac0f
            {r: 155, g: 188, b: 15}  // #9bbc0f
        ];

        // 監聽圖片上傳
        upload.addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                img.onload = function() {
                    render();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        // 監聽控制項變化
        [pixelSizeInput, colorDepthInput, gbModeInput, ditherInput].forEach(el => {
            el.addEventListener('input', render);
        });

        function render() {
            if (!img.src) return;

            // 更新顯示數值
            const size = parseInt(pixelSizeInput.value);
            const depth = parseInt(colorDepthInput.value);
            pixelVal.textContent = size;
            colorVal.textContent = depth;

            // 1. 設定畫布大小 (縮小後的尺寸)
            const w = img.width;
            const h = img.height;
            
            // 計算縮小後的解析度
            const smW = Math.floor(w / size);
            const smH = Math.floor(h / size);

            canvas.width = smW;
            canvas.height = smH;

            // 2. 繪製縮小的圖片 (第一步像素化)
            ctx.drawImage(img, 0, 0, smW, smH);

            // 3. 取得像素資料進行顏色處理
            const imageData = ctx.getImageData(0, 0, smW, smH);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i+1];
                let b = data[i+2];

                if (gbModeInput.checked) {
                    // --- GameBoy 模式 ---
                    // 計算亮度 (Luminance)
                    const avg = 0.299 * r + 0.587 * g + 0.114 * b;
                    
                    // 簡單的抖動處理 (Bayer Dithering 模擬)
                    let dither = 0;
                    if (ditherInput.checked) {
                        // 根據像素位置添加隨機噪點模擬抖動
                        dither = (Math.random() - 0.5) * 30; 
                    }

                    // 映射到 4 個顏色
                    let index = 0;
                    const val = avg + dither;
                    
                    if (val < 64) index = 0;
                    else if (val < 128) index = 1;
                    else if (val < 192) index = 2;
                    else index = 3;

                    const color = gbPalette[index];
                    data[i] = color.r;
                    data[i+1] = color.g;
                    data[i+2] = color.b;

                } else {
                    // --- 通用色彩限制 (Posterization) ---
                    // 公式：Math.floor(顏色 / 階層) * 階層
                    // 為了讓顏色分佈更均勻，做一點調整
                    const step = 255 / (depth - 1);
                    
                    data[i] = Math.floor(r / step) * step;
                    data[i+1] = Math.floor(g / step) * step;
                    data[i+2] = Math.floor(b / step) * step;
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // 下載功能
        downloadBtn.addEventListener('click', () => {
            if (!img.src) return;
            // 為了讓下載的圖片是清晰的大圖，我們建立一個臨時 canvas
            const link = document.createElement('a');
            link.download = 'pixel-art.png';
            
            // 這裡有個小技巧：如果要下載「放大後」的清晰像素圖
            // 可以直接用 canvas.toDataURL，因為我們在 CSS 設定了 image-rendering: pixelated
            // 但為了確保檔案本身是大的，我們可以在這裡做一次放大繪製，或者直接下載小的讓使用者自己縮放
            // 這裡我們先下載當前畫布內容 (小圖)，這是最標準的像素檔
            link.href = canvas.toDataURL();
            link.click();
        });
    </script>
</body>
</html>

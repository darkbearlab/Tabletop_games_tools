<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Console Pixel Converter</title>
    <style>
        /* 樣式保持之前優化過的版本 */
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
        }
        h1 { margin-bottom: 20px; text-transform: uppercase; border-bottom: 2px solid #e74c3c; font-size: 1.5rem; }
        
        .controls {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        label { margin-bottom: 5px; font-weight: bold; font-size: 0.85em; }
        input[type="range"], select { cursor: pointer; }
        select { padding: 5px; border-radius: 4px; background: #ecf0f1; border: none; font-family: inherit; }

        .btn {
            background-color: #e67e22;
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .btn:hover { background-color: #d35400; }
        .btn-download { background-color: #27ae60; }
        .btn-download:hover { background-color: #2ecc71; }

        #canvas-container {
            position: relative;
            border: 4px solid #95a5a6;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAADFJREFUOE9jZGVl/c+AEzCSqHgUE2AAiG109//Jkyf/kTQ9jY6G4WgYkA4GHOanhQEA+ygT915/6qEAAAAASUVORK5CYII='); 
            width: 100%;
            height: 60vh; 
            max-width: 900px; 
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: #111;
        }
        
        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            image-rendering: pixelated; 
        }
    </style>
</head>
<body>

    <h1>復古主機濾鏡</h1>

    <div class="controls">
        <div class="control-group">
            <label>1. 上傳圖片</label>
            <input type="file" id="upload" accept="image/*">
        </div>

        <div class="control-group">
            <label for="consoleMode">2. 選擇主機風格</label>
            <select id="consoleMode">
                <option value="none">自定義 (滑桿控制)</option>
                <option value="gb">GameBoy (綠色調)</option>
                <option value="nes">NES (紅白機 54色)</option>
                <option value="sega">Sega MD (9-bit Color)</option>
                <option value="snes">SNES (15-bit Color)</option>
                <option value="bw">1-bit (黑白)</option>
            </select>
        </div>

        <div class="control-group">
            <label for="pixelSize">像素大小: <span id="pixelVal">6</span></label>
            <input type="range" id="pixelSize" min="1" max="64" value="6">
        </div>

        <div class="control-group" id="customControls">
            <label for="colorDepth">色彩簡化 (自定義用): <span id="colorVal">16</span></label>
            <input type="range" id="colorDepth" min="2" max="64" value="16" step="2">
        </div>

        <div class="control-group">
            <label>特效</label>
            <div style="margin-top:5px;">
                <input type="checkbox" id="dither"> 
                <label for="dither" style="display:inline; cursor:pointer;">隨機抖動</label>
            </div>
        </div>
        
        <div class="control-group" style="justify-content: flex-end;">
            <button class="btn btn-download" id="downloadBtn">下載大圖</button>
        </div>
    </div>

    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <script>
        const upload = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');

        const pixelSizeInput = document.getElementById('pixelSize');
        const colorDepthInput = document.getElementById('colorDepth');
        const consoleModeInput = document.getElementById('consoleMode'); // 新增
        const ditherInput = document.getElementById('dither');
        const pixelVal = document.getElementById('pixelVal');
        const colorVal = document.getElementById('colorVal');
        const downloadBtn = document.getElementById('downloadBtn');

        let img = new Image();
        
        // --- 核心資料區 ---

        // GameBoy 綠色調
        const gbPalette = [
            {r: 15, g: 56, b: 15}, {r: 48, g: 98, b: 48}, 
            {r: 139, g: 172, b: 15}, {r: 155, g: 188, b: 15}
        ];

        // NES (紅白機) 標準色票 - 這是最經典的 54 色
        const nesPaletteHex = [
            '#7C7C7C', '#0000FC', '#0000BC', '#4428BC', '#940084', '#A80020', '#A81000', '#881400',
            '#503000', '#007800', '#006800', '#005800', '#004058', '#000000',
            '#BCBCBC', '#0078F8', '#0058F8', '#6844FC', '#D800CC', '#E40058', '#F83800', '#E45C10',
            '#AC7C00', '#00B800', '#00A800', '#00A844', '#008888', '#000000',
            '#F8F8F8', '#3CBCFC', '#6888FC', '#9878F8', '#F878F8', '#F85898', '#F87858', '#FCA044',
            '#F8B800', '#B8F818', '#58D854', '#58F898', '#00E8D8', '#787878',
            '#FCFCFC', '#A4E4FC', '#B8B8F8', '#D8B8F8', '#F8B8F8', '#F8A4C0', '#F0D0B0', '#FCE0A8',
            '#F8D878', '#D8F878', '#B8F8B8', '#B8F8D8', '#00FCFC', '#F8D8F8'
        ];
        
        // 將 Hex 轉為 RGB 陣列以便計算距離
        const nesPalette = nesPaletteHex.map(hex => {
            return {
                r: parseInt(hex.slice(1, 3), 16),
                g: parseInt(hex.slice(3, 5), 16),
                b: parseInt(hex.slice(5, 7), 16)
            };
        });

        // 輔助函式：尋找色票中最接近的顏色 (最短歐幾里得距離)
        function findClosestColor(r, g, b, palette) {
            let minDist = Infinity;
            let closest = palette[0];
            for (let i = 0; i < palette.length; i++) {
                const c = palette[i];
                // 使用加權距離讓顏色更自然 (人眼對綠色較敏感)
                // 這裡簡化使用標準距離平方
                const dist = (r - c.r) ** 2 + (g - c.g) ** 2 + (b - c.b) ** 2;
                if (dist < minDist) {
                    minDist = dist;
                    closest = c;
                }
            }
            return closest;
        }

        // 輔助函式：限制通道色階 (用於 Sega/SNES 模擬)
        function limitChannel(val, levels) {
            const step = 255 / (levels - 1);
            return Math.round(val / step) * step;
        }

        upload.addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                img.onload = render;
                img.src = event.target.result;
            }
            if (e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
        });

        [pixelSizeInput, colorDepthInput, consoleModeInput, ditherInput].forEach(el => {
            el.addEventListener('input', render);
        });

        function render() {
            if (!img.src) return;

            const size = parseInt(pixelSizeInput.value);
            const mode = consoleModeInput.value;
            const customDepth = parseInt(colorDepthInput.value);
            
            pixelVal.textContent = size;
            colorVal.textContent = customDepth;

            const w = img.width;
            const h = img.height;
            let safeSize = size < 1 ? 1 : size;
            const smW = Math.floor(w / safeSize);
            const smH = Math.floor(h / safeSize);

            tempCanvas.width = smW;
            tempCanvas.height = smH;
            tempCtx.imageSmoothingEnabled = false;
            tempCtx.drawImage(img, 0, 0, smW, smH);

            const imageData = tempCtx.getImageData(0, 0, smW, smH);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i+1];
                let b = data[i+2];

                // 隨機抖動處理
                let dither = 0;
                if (ditherInput.checked) {
                    dither = (Math.random() - 0.5) * 20;
                    r = Math.min(255, Math.max(0, r + dither));
                    g = Math.min(255, Math.max(0, g + dither));
                    b = Math.min(255, Math.max(0, b + dither));
                }

                // --- 色彩處理核心邏輯 ---
                if (mode === 'gb') {
                    // GameBoy (4階綠色)
                    const avg = 0.299 * r + 0.587 * g + 0.114 * b;
                    let index = 0;
                    if (avg < 64) index = 0;
                    else if (avg < 128) index = 1;
                    else if (avg < 192) index = 2;
                    else index = 3;
                    const c = gbPalette[index];
                    r = c.r; g = c.g; b = c.b;

                } else if (mode === 'nes') {
                    // NES (紅白機 54色比對)
                    const c = findClosestColor(r, g, b, nesPalette);
                    r = c.r; g = c.g; b = c.b;

                } else if (mode === 'sega') {
                    // Sega Mega Drive (3 bits/channel = 8 levels)
                    // 0, 36, 73...
                    r = limitChannel(r, 8);
                    g = limitChannel(g, 8);
                    b = limitChannel(b, 8);

                } else if (mode === 'snes') {
                    // SNES (5 bits/channel = 32 levels)
                    r = limitChannel(r, 32);
                    g = limitChannel(g, 32);
                    b = limitChannel(b, 32);

                } else if (mode === 'bw') {
                    // 1-Bit (黑白)
                    const avg = 0.299 * r + 0.587 * g + 0.114 * b;
                    const val = avg > 127 ? 255 : 0;
                    r = val; g = val; b = val;

                } else {
                    // 自定義模式
                    r = limitChannel(r, customDepth);
                    g = limitChannel(g, customDepth);
                    b = limitChannel(b, customDepth);
                }

                data[i] = r;
                data[i+1] = g;
                data[i+2] = b;
            }

            tempCtx.putImageData(imageData, 0, 0);

            canvas.width = w;
            canvas.height = h;
            ctx.imageSmoothingEnabled = false;
            ctx.mozImageSmoothingEnabled = false;
            ctx.webkitImageSmoothingEnabled = false;
            ctx.msImageSmoothingEnabled = false;
            ctx.drawImage(tempCanvas, 0, 0, smW, smH, 0, 0, w, h);
        }

        downloadBtn.addEventListener('click', () => {
            if (!img.src) return;
            const link = document.createElement('a');
            link.download = `pixel-art-${consoleModeInput.value}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    </script>
</body>
</html>

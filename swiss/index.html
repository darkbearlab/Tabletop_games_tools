<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‘å£«åˆ¶è³½æœƒç®¡ç†ç³»çµ±</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
        h1, h2 { color: #1e293b; margin-top: 0; }
        
        /* ä½ˆå±€èˆ‡å¡ç‰‡ */
        .section { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none; }
        
        /* è¨­å®šå€å¡Šæ¨£å¼ */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: #f1f5f9; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
        .setting-item label { display: block; font-size: 0.9em; margin-bottom: 5px; font-weight: bold; color: #475569; }
        .setting-item input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; box-sizing: border-box; }

        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 4px; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        button.danger { background: #ef4444; }
        button.secondary { background: #64748b; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: #64748b; font-size: 0.9em; }
        
        /* å°æˆ°çµ„åˆæ¨£å¼ */
        .match-card { display: flex; align-items: center; justify-content: space-between; background: #eff6ff; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #dbeafe; }
        .vs { font-weight: bold; color: #94a3b8; margin: 0 10px; font-size: 0.8em; }
        .match-player { flex: 1; font-weight: 600; }
        .match-player span { font-weight: normal; font-size: 0.85em; color: #64748b; }
        .result-select { padding: 5px; border-radius: 4px; border: 1px solid #cbd5e1; }
        
        .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }
        .tag-win { background: #dcfce7; color: #166534; }
        .tag-loss { background: #fee2e2; color: #991b1b; }
        
        /* å† è»æ¨£å¼ */
        .trophy { color: #eab308; margin-right: 5px; }
        .final-banner { background: #ecfccb; color: #365314; padding: 15px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 20px; border: 1px solid #bef264; }
    </style>
</head>
<body>

    <h1>ğŸ† ç‘å£«åˆ¶è³½æœƒç®¡ç†ç³»çµ±</h1>

    <div id="setup-phase" class="section">
        <h2>1. è³½äº‹è¨­å®šèˆ‡é¸æ‰‹ç™»éŒ„</h2>
        
        <div class="settings-grid">
            <div class="setting-item">
                <label>å‹å ´å¾—åˆ† (Win)</label>
                <input type="number" id="pts-win" value="1" step="0.5">
            </div>
            <div class="setting-item">
                <label>å¹³æ‰‹å¾—åˆ† (Draw)</label>
                <input type="number" id="pts-draw" value="0.5" step="0.5">
            </div>
            <div class="setting-item">
                <label>æ•—å ´å¾—åˆ† (Loss)</label>
                <input type="number" id="pts-loss" value="0" step="0.5">
            </div>
            <div class="setting-item">
                <label>ç¸½è¼ªæ•¸ (Rounds)</label>
                <input type="number" id="total-rounds" value="3" min="1">
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="player-name" placeholder="è¼¸å…¥é¸æ‰‹åç¨± (æŒ‰ Enter æ–°å¢)" onkeypress="handleEnter(event)">
            <button onclick="addPlayer()">æ–°å¢é¸æ‰‹</button>
        </div>
        
        <div id="player-list">
            </div>
        
        <div style="margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 15px;">
            <span id="player-count" style="margin-right: 15px; font-weight: bold; color: #64748b;">ç›®å‰äººæ•¸: 0</span>
            <button onclick="startTournament()">é–‹å§‹æ¯”è³½</button>
        </div>
    </div>

    <div id="tournament-phase" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="round-title" style="margin:0;">ç¬¬ 1 è¼ªå°æˆ°</h2>
            <div style="font-size: 0.9em; color: #64748b;">
                ç›®æ¨™è¼ªæ•¸: <span id="display-total-rounds">3</span>
            </div>
        </div>
        
        <div id="matches-container">
            </div>

        <div style="margin-top: 20px; text-align: right;">
            <button id="btn-next-round" onclick="finishRound()">çµç®—æœ¬è¼ªä¸¦é€²å…¥ä¸‹ä¸€è¼ª</button>
            <button id="btn-end-tournament" class="secondary hidden" onclick="endTournamentExplicitly()">çµæŸæ¯”è³½</button>
        </div>
    </div>

    <div id="standings-phase" class="section hidden">
        <div id="final-message" class="hidden"></div> <h2>ğŸ“Š å³æ™‚æ’å</h2>
        <table>
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>é¸æ‰‹</th>
                    <th>ç©åˆ†</th>
                    <th>å°æ‰‹åˆ† (SOS)</th>
                    <th>æˆ°ç¸¾</th>
                </tr>
            </thead>
            <tbody id="standings-body">
                </tbody>
        </table>
        
        <div style="margin-top: 20px; text-align: right;">
             <button class="secondary" onclick="resetTournament()" style="font-size: 0.8em;">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>

<script>
    // --- è³‡æ–™çµæ§‹ ---
    let players = []; 
    let currentRound = 0;
    let matches = []; 
    
    // è³½äº‹è¨­å®š (é è¨­å€¼)
    let config = {
        winPts: 1,
        drawPts: 0.5,
        lossPts: 0,
        totalRounds: 3
    };
    
    // --- è¨­å®šéšæ®µé‚è¼¯ ---
    function handleEnter(e) {
        if (e.key === 'Enter') addPlayer();
    }

    function addPlayer() {
        const input = document.getElementById('player-name');
        const name = input.value.trim();
        if (!name) return;

        const newPlayer = {
            id: Date.now() + Math.random().toString(36).substr(2, 5),
            name: name,
            score: 0,
            opponents: [],
            sos: 0,
            wins: 0, draws: 0, losses: 0
        };
        
        players.push(newPlayer);
        input.value = '';
        renderPlayerList();
    }

    function removePlayer(id) {
        players = players.filter(p => p.id !== id);
        renderPlayerList();
    }

    function renderPlayerList() {
        const list = document.getElementById('player-list');
        document.getElementById('player-count').innerText = `ç›®å‰äººæ•¸: ${players.length}`;
        
        if (players.length === 0) {
            list.innerHTML = '<p style="color: #64748b; text-align:center; padding: 20px;">å°šæœªåŠ å…¥é¸æ‰‹...</p>';
            return;
        }

        let html = '<table><thead><tr><th>åç¨±</th><th style="width:80px;">æ“ä½œ</th></tr></thead><tbody>';
        players.forEach(p => {
            html += `<tr>
                <td>${p.name}</td>
                <td><button class="danger" style="padding: 4px 8px; font-size: 0.8em;" onclick="removePlayer('${p.id}')">ç§»é™¤</button></td>
            </tr>`;
        });
        html += '</tbody></table>';
        list.innerHTML = html;
    }

    function startTournament() {
        if (players.length < 2) {
            alert("è‡³å°‘éœ€è¦ 2 åé¸æ‰‹æ‰èƒ½é–‹å§‹ï¼");
            return;
        }

        // è®€å–è¨­å®šå€¼
        config.winPts = parseFloat(document.getElementById('pts-win').value) || 1;
        config.drawPts = parseFloat(document.getElementById('pts-draw').value) || 0.5;
        config.lossPts = parseFloat(document.getElementById('pts-loss').value) || 0;
        config.totalRounds = parseInt(document.getElementById('total-rounds').value) || 3;

        // UI åˆ‡æ›
        document.getElementById('setup-phase').classList.add('hidden');
        document.getElementById('tournament-phase').classList.remove('hidden');
        document.getElementById('standings-phase').classList.remove('hidden');
        document.getElementById('display-total-rounds').innerText = config.totalRounds;
        
        currentRound = 0;
        nextRound();
    }

    // --- é…å°é‚è¼¯ ---
    function generatePairings() {
        let sortedPlayers = [...players].sort((a, b) => b.score - a.score || 0.5 - Math.random());
        let roundMatches = [];
        let byePlayer = null;

        if (sortedPlayers.length % 2 !== 0) {
            // å„ªå…ˆè®“åˆ†æ•¸æœ€ä½ä¸”æ²’è¼ªç©ºéçš„äººè¼ªç©º (ç°¡åŒ–ç‰ˆï¼šç›´æ¥å–æœ€å¾Œä¸€å)
            byePlayer = sortedPlayers.pop(); 
        }

        while (sortedPlayers.length > 0) {
            let p1 = sortedPlayers.shift();
            let p2Index = -1;

            for (let i = 0; i < sortedPlayers.length; i++) {
                if (!p1.opponents.includes(sortedPlayers[i].id)) {
                    p2Index = i;
                    break;
                }
            }
            
            if (p2Index === -1) p2Index = 0; // å¼·åˆ¶é…å°

            let p2 = sortedPlayers.splice(p2Index, 1)[0];
            roundMatches.push({ p1: p1, p2: p2 });
        }

        return { matches: roundMatches, bye: byePlayer };
    }

    function nextRound() {
        currentRound++;
        document.getElementById('round-title').innerText = `ç¬¬ ${currentRound} / ${config.totalRounds} è¼ªå°æˆ°`;
        
        const pairingResult = generatePairings();
        matches = pairingResult.matches;
        
        const container = document.getElementById('matches-container');
        container.innerHTML = '';

        matches.forEach((m, index) => {
            const div = document.createElement('div');
            div.className = 'match-card';
            div.innerHTML = `
                <div class="match-player" style="text-align: right;">${m.p1.name} <span>(${m.p1.score}åˆ†)</span></div>
                <div class="vs">VS</div>
                <div class="match-player">${m.p2.name} <span>(${m.p2.score}åˆ†)</span></div>
                <select id="match-result-${index}" class="result-select">
                    <option value="">è¼¸å…¥çµæœ...</option>
                    <option value="p1_win">${m.p1.name} å‹</option>
                    <option value="p2_win">${m.p2.name} å‹</option>
                    <option value="draw">å¹³æ‰‹</option>
                </select>
            `;
            container.appendChild(div);
        });

        if (pairingResult.bye) {
            const div = document.createElement('div');
            div.className = 'match-card';
            div.style.background = '#f0fdf4';
            div.style.borderColor = '#bbf7d0';
            div.innerHTML = `
                <div class="match-player">è¼ªç©º (Bye)</div>
                <div style="flex: 2; text-align: center; color: #166534; font-size: 0.9em;">
                    ${pairingResult.bye.name} è‡ªå‹•ç²å‹ (å¾— ${config.winPts} åˆ†)
                </div>
                <input type="hidden" id="bye-player-id" value="${pairingResult.bye.id}">
            `;
            container.appendChild(div);
        } else {
             const existingBye = document.getElementById('bye-player-id');
             if(existingBye) existingBye.remove();
        }

        // æ»¾å‹•åˆ°æœ€ä¸Šæ–¹
        window.scrollTo(0, 0);
    }

    function finishRound() {
        // 1. æª¢æŸ¥è¼¸å…¥
        for (let i = 0; i < matches.length; i++) {
            const result = document.getElementById(`match-result-${i}`).value;
            if (!result) {
                alert("è«‹è¼¸å…¥æ‰€æœ‰æ¯”è³½çš„çµæœï¼");
                return;
            }
        }

        // 2. æ›´æ–°åˆ†æ•¸ (ä½¿ç”¨ Config è¨­å®šçš„å€¼)
        matches.forEach((m, index) => {
            const result = document.getElementById(`match-result-${index}`).value;
            const p1 = players.find(p => p.id === m.p1.id);
            const p2 = players.find(p => p.id === m.p2.id);

            p1.opponents.push(p2.id);
            p2.opponents.push(p1.id);

            if (result === 'p1_win') {
                p1.score += config.winPts; p2.score += config.lossPts;
                p1.wins++; p2.losses++;
            } else if (result === 'p2_win') {
                p2.score += config.winPts; p1.score += config.lossPts;
                p2.wins++; p1.losses++;
            } else {
                p1.score += config.drawPts; p2.score += config.drawPts;
                p1.draws++; p2.draws++;
            }
        });

        // 3. è™•ç†è¼ªç©º (é€šå¸¸è¼ªç©ºè¦–ç‚ºå‹å ´)
        const byeInput = document.getElementById('bye-player-id');
        if (byeInput) {
            const byePlayer = players.find(p => p.id === byeInput.value);
            if (byePlayer) {
                byePlayer.score += config.winPts; // è¼ªç©ºå¾—å‹å ´åˆ†
                byePlayer.wins++;
            }
        }

        calculateSOS();
        updateStandings();

        // 4. åˆ¤æ–·æ¯”è³½æ˜¯å¦çµæŸ
        if (currentRound >= config.totalRounds) {
            showFinalResults();
        } else {
            setTimeout(() => {
                alert(`ç¬¬ ${currentRound} è¼ªçµæŸï¼æº–å‚™ä¸‹ä¸€è¼ªã€‚`);
                nextRound();
            }, 100);
        }
    }

    function showFinalResults() {
        document.getElementById('matches-container').innerHTML = ''; 
        document.getElementById('round-title').innerText = "ğŸ æ¯”è³½çµæŸ";
        document.getElementById('btn-next-round').classList.add('hidden'); 
        
        const sorted = getSortedPlayers();
        const topPlayer = sorted[0];

        // æ‰¾å‡ºæ‰€æœ‰æ•¸æ“šè·Ÿç¬¬ä¸€åå®Œå…¨ä¸€æ¨£çš„äºº (ä¸¦åˆ—å† è»)
        const champions = sorted.filter(p => 
            p.score === topPlayer.score && 
            p.sos === topPlayer.sos && 
            p.wins === topPlayer.wins
        );

        // çµ„åˆåå­—ï¼Œä¾‹å¦‚ "å°æ˜ & å°è¯"
        const championNames = champions.map(c => c.name).join(" & ");
        
        // é¡¯ç¤ºæ–‡å­—èª¿æ•´
        const titleText = champions.length > 1 ? "ä¸¦åˆ—å† è»" : "å† è»";

        const banner = document.getElementById('final-message');
        banner.innerHTML = `<span class="trophy">ğŸ†</span> ${titleText}ï¼š${championNames} <br><span style="font-size:0.8em; font-weight:normal">(ç©åˆ† ${topPlayer.score} / SOS ${topPlayer.sos.toFixed(1)})</span>`;
        banner.className = 'final-banner';
        banner.classList.remove('hidden');

        alert(`æ¯”è³½å…¨éƒ¨çµæŸï¼æ­å–œ ${championNames} ç²å¾—${titleText}ï¼`);
    }
    
    // é›–ç„¶æ²’ç”¨åˆ°ï¼Œä½†ä¿ç•™çµ¦æ‰‹å‹•çµæŸç”¨
    function endTournamentExplicitly() {
        if(confirm("ç¢ºå®šè¦æå‰çµæŸæ¯”è³½å—ï¼Ÿ")) showFinalResults();
    }

    function calculateSOS() {
        players.forEach(p => {
            let sos = 0;
            p.opponents.forEach(oid => {
                const opponent = players.find(op => op.id === oid);
                if (opponent) sos += opponent.score;
            });
            p.sos = sos; // å¦‚æœåˆ†æ•¸æœ‰å°æ•¸é»ï¼ŒJSæœƒè‡ªå‹•è™•ç†
        });
    }

    function getSortedPlayers() {
        return [...players].sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            if (b.sos !== a.sos) return b.sos - a.sos;
            return b.wins - a.wins;
        });
    }

    function updateStandings() {
        const tbody = document.getElementById('standings-body');
        const sorted = getSortedPlayers();

        let html = '';
        
        // ç”¨ä¾†è¿½è¹¤ç•¶å‰çš„æ’åé‚è¼¯
        let currentRank = 1;

        sorted.forEach((p, index) => {
            // åˆ¤æ–·æ˜¯å¦èˆ‡ä¸Šä¸€åã€Œå®Œå…¨å¹³æ‰‹ã€(ç©åˆ†ã€SOSã€å‹å ´éƒ½ä¸€æ¨£)
            let isTied = false;
            if (index > 0) {
                const prev = sorted[index - 1];
                if (p.score === prev.score && p.sos === prev.sos && p.wins === prev.wins) {
                    isTied = true;
                }
            }

            // å¦‚æœæ²’æœ‰å¹³æ‰‹ï¼Œæ’åå°±è·³åˆ°ç›®å‰çš„ index + 1
            // ä¾‹å¦‚ï¼šç¬¬0å€‹æ˜¯ç¬¬1åï¼Œç¬¬1å€‹è‹¥æ²’å¹³æ‰‹å°±æ˜¯ç¬¬2å
            // å¦‚æœç¬¬1å€‹è·Ÿç¬¬0å€‹å¹³æ‰‹ï¼Œå®ƒä¾ç„¶é¡¯ç¤ºç¬¬1åï¼Œä½†ä¸‹ä¸€å€‹äºº(index 2)æœƒè®Šæˆç¬¬3å
            if (!isTied) {
                currentRank = index + 1;
            }

            // æ¨£å¼è¨­å®šï¼šåªæœ‰ç¬¬ 1 å (åŒ…å«ä¸¦åˆ—) æ‰æœ‰å† è»è‰²
            let rankClass = currentRank === 1 ? 'color:#eab308; font-weight:bold;' : '';
            let rankIcon = currentRank === 1 ? 'ğŸ† ' : '';
            
            html += `<tr>
                <td style="${rankClass}">${rankIcon}${currentRank}</td>
                <td style="${rankClass}">${p.name}</td>
                <td style="font-weight:bold; color:var(--primary)">${p.score}</td>
                <td>${p.sos.toFixed(1)}</td>
                <td><span class="tag tag-win">${p.wins}W</span> ${p.draws}D <span class="tag tag-loss">${p.losses}L</span></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function resetTournament() {
        if(confirm("è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ‰€æœ‰æ¯”è³½ç´€éŒ„å’Œè¨­å®šï¼Œç¢ºå®šé‡ç½®å—ï¼Ÿ")) {
            location.reload(); // æœ€ç°¡å–®ä¹¾æ·¨çš„é‡ç½®æ–¹å¼
        }
    }
</script>

</body>
</html>
